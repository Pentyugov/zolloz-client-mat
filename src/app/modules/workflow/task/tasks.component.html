<mat-progress-bar mode="indeterminate" value="40" *ngIf="refreshing"></mat-progress-bar>
<div fxLayout="row wrap" *ngIf="!isWidget">

  <div fxFlex.gt-sm="25" fxFlex.gt-xs="100" fxFlex="100">
    <mat-card>
      <div class="box p-20 bg-info text-center cursor-pointer"
           [ngClass]="{
           'priority-box-active' : activeBoxId === ALL && isDarkMode,
           'priority-box-active-dark' : activeBoxId === ALL && !isDarkMode
           }"
           matRipple
           (click)="filterByPriority(ALL, true)">
        <h1 class="font-light text-white m-0">{{ totalCount }}</h1>
        <h6 class="text-white m-0">{{'TotalTasks' | translate}}</h6>
      </div>
    </mat-card>
  </div>

  <div fxFlex.gt-sm="25" fxFlex.gt-xs="100" fxFlex="100">
    <mat-card>
      <div class="box p-20 bg-success text-center cursor-pointer"
           [ngClass]="{
           'priority-box-active' : activeBoxId === LOW && isDarkMode,
           'priority-box-active-dark' : activeBoxId === LOW && !isDarkMode
           }"
           matRipple
           (click)="filterByPriority(LOW, true)">
        <h1 class="font-light text-white m-0">{{ lowPriority }}</h1>
        <h6 class="text-white m-0">{{'Tasks.Priority.Low' | translate}}</h6>
      </div>
    </mat-card>
  </div>

  <div fxFlex.gt-sm="25" fxFlex.gt-xs="100" fxFlex="100">
    <mat-card>
      <div class="box p-20 bg-warning text-center cursor-pointer"
           [ngClass]="{
           'priority-box-active' : activeBoxId === MEDIUM && isDarkMode,
           'priority-box-active-dark' : activeBoxId === MEDIUM && !isDarkMode
           }"
           matRipple
           (click)="filterByPriority(MEDIUM, true)">
        <h1 class="font-light text-white m-0">{{ mediumPriority }}</h1>
        <h6 class="text-white m-0">{{'Tasks.Priority.Middle' | translate}}</h6>
      </div>
    </mat-card>
  </div>

  <div fxFlex.gt-sm="25" fxFlex.gt-xs="100" fxFlex="100">
    <mat-card>
      <div class="box p-20 bg-danger text-center cursor-pointer"
           [ngClass]="{
           'priority-box-active' : activeBoxId === HIGH && isDarkMode,
           'priority-box-active-dark' : activeBoxId === HIGH && !isDarkMode
           }"
           matRipple
           (click)="filterByPriority(HIGH, true)">
        <h1 class="font-light text-white m-0">{{ highPriority }}</h1>
        <h6 class="text-white m-0">{{'Tasks.Priority.High' | translate}}</h6>
      </div>
    </mat-card>
  </div>



</div>

<div fxLayout="row wrap" *ngIf="!isWidget">
  <div fxFlex="100">
    <mat-card>
      <mat-card-content>
        <div fxLayout="row wrap" class="align-items-center">

          <div fxFlex.gt-md="30" fxFlex.gt-lg="20" fxFlex.gt-xs="50" fxFlex="100" [ngClass.xs]="{'text-center' : true}">
            <mat-form-field>
              <input matInput
                     [(ngModel)]="filterString"
                     (keyup)="applyFilter($event.target.value)"
                     placeholder="{{'Tasks.Search' | translate}}"
              />
            </mat-form-field>
          </div>

          <div fxFlex.gt-md="70" fxFlex.gt-lg="80" fxFlex.gt-xs="50" fxFlex="100" [ngClass.xs]="{'text-center' : true}" [ngClass.gt-xs]="{'text-right' : true}">
            <button mat-raised-button
                    *ngIf="isActionPermit(CREATE_ACTION)"
                    color="primary"
                    style="margin: 5px"
                    (click)="openAddDialog(null)">
              <i class="fa fa-plus"></i>
            </button>

            <button mat-raised-button
                    *ngIf="isActionPermit(EDIT_ACTION)"
                    color="accent"
                    style="margin: 5px"
                    (click)="openEditor()"
                    [disabled]="!clickedRow">
              <i class="fa fa-pencil"></i>
            </button>

            <button mat-raised-button
                    *ngIf="isActionPermit(DELETE_ACTION)"
                    color="warn"
                    style="margin: 5px"
                    (click)="openDeleteDialog(clickedRow)"
                    [disabled]="!clickedRow">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>

        <div fxLayout="row wrap" class="align-items-center">

          <div fxFlex.gt-md="30" fxFlex.gt-lg="15" fxFlex.gt-xs="100" fxFlex="100" class="m-r-15">
            <mat-form-field appearance="outline">
              <mat-label>{{'AddFilter' | translate}}</mat-label>
              <mat-select placeholder="{{'AddFilter' | translate}}"
                          [formControl]="filterControl"
                          (selectionChange)="addFilter(($event))">
                <mat-option [value]="null">{{'None' | translate}}</mat-option>
                <mat-option *ngFor="let filter of filtersList"
                            [disabled]="isFilterInList(filter)"
                            [value]="filter">
                  {{capitalize(filter.name) | translate}}
                </mat-option>
              </mat-select>
            </mat-form-field>
          </div>

          <div fxFlex.gt-md="30" fxFlex.gt-lg="15" fxFlex.gt-xs="100" fxFlex="100" *ngFor="let filter of appliedFilters"  class="m-r-15">
            <mat-form-field appearance="outline">
              <mat-label>{{capitalize(filter.property) | translate}}</mat-label>
              <mat-select placeholder="{{capitalize(filter.property) | translate}}" [(ngModel)]="filter.condition">
                <mat-option [value]="null">{{'None' | translate}}</mat-option>
                <mat-option *ngFor="let option of filter.options" [value]="option.id">
                  {{ option.name | translate }}
                </mat-option>

              </mat-select>
              <mat-hint class="hint" (click)="removeFilter(filter)">
                {{'Delete' | translate}}
              </mat-hint>
            </mat-form-field>
          </div>


        </div>

        <div fxLayout="row wrap" class="align-items-center">
          <div fxFlex="25" class="text-left">
            <button mat-raised-button
                    color="primary"
                    style="margin: 5px"
                    (click)="onApplyFilters()">
              {{'ApplyFilter' | translate}}
            </button>
          </div>
        </div>

      </mat-card-content>
    </mat-card>
  </div>
</div>


<mat-card>
  <mat-card-content>
    <mat-card-title *ngIf="isWidget">{{'Tasks.MyActiveTasks' | translate}}</mat-card-title>
    <div class="table-responsive">
      <table mat-table matSort multiTemplateDataRows [dataSource]="dataSource" class="mat-elevation-z8 table ticket-list no-wrap">

        <ng-container matColumnDef="number">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>{{'Number' | translate}}</th>
          <td mat-cell *matCellDef="let element">
            {{ element.number}}
          </td>
        </ng-container>

        <ng-container matColumnDef="state">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>{{'State' | translate}}</th>
          <td mat-cell *matCellDef="let element">
            {{ element.state | translate}}
          </td>
        </ng-container>

        <ng-container matColumnDef="priority">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>{{'Priority' | translate}}</th>
          <td mat-cell *matCellDef="let element">
            {{ getPriority(element.priority) | translate }}
          </td>
        </ng-container>

        <ng-container matColumnDef="description">
          <th mat-header-cell *matHeaderCellDef>{{'Description' | translate}}</th>
          <td mat-cell *matCellDef="let element">
            {{ getMaxTextLength(element.description, 40) }}
          </td>
        </ng-container>

        <ng-container matColumnDef="project">
          <th mat-header-cell *matHeaderCellDef>{{'Project' | translate}}</th>
          <td mat-cell *matCellDef="let element">
            {{element.project?.name}}
          </td>
        </ng-container>

        <ng-container matColumnDef="dueDate">
          <th mat-header-cell *matHeaderCellDef>{{'DueDate' | translate}}</th>
          <td mat-cell *matCellDef="let element" [ngClass]="{'overdue' : element.overdue}">
            {{ element.executionDatePlan | date : 'dd.MM.yyyy HH:mm' }}
          </td>
        </ng-container>

        <ng-container matColumnDef="executionDateFact">
          <th mat-header-cell *matHeaderCellDef>{{'ExecutionDateFact' | translate}}</th>
          <td mat-cell *matCellDef="let element" [ngClass]="{'overdue' : element.overdue}">
            {{ element.executionDateFact | date : 'dd.MM.yyyy HH:mm' }}
          </td>
        </ng-container>

        <ng-container matColumnDef="initiator">
          <th mat-header-cell *matHeaderCellDef>{{'Initiator' | translate}}</th>
          <td mat-cell *matCellDef="let element">
            {{ element.initiator?.username }}
          </td>
        </ng-container>

        <ng-container matColumnDef="executor" *ngIf="!isWidget">
          <th mat-header-cell *matHeaderCellDef>{{'Executor' | translate}}</th>
          <td mat-cell *matCellDef="let element">
            {{ getMaxTextLength(element.executor?.username, 30) }}
          </td>
        </ng-container>

        <!-- Expanded Content Column - The detail row is made up of this one column that spans across all columns -->
        <ng-container matColumnDef="expandedDetail">
          <td mat-cell *matCellDef="let element" [attr.colspan]="columnsToDisplay.length">
            <div
              class="element-detail"
              [@detailExpand]="element === expandedElement ? 'expanded' : 'collapsed'"
            >
              <!--              <div class="truncate-cell">{{getMaxTextLength(element.description, 50)}}</div>-->
              <div fxLayout="row wrap">
                <div fxFlex="100">
                  <div class="element-description">
                    {{'Description' | translate}}
                    <span class="element-description-attribution"> - {{getMaxTextLength(element.description, 150)}} </span>
                  </div>
                </div>
                <div fxFlex="100" *ngIf="element.comment">
                  <div class="element-description">
                    {{'Comment' | translate}}
                    <span class="element-description-attribution"> - {{getMaxTextLength(element.comment, 150)}} </span>
                  </div>
                </div>
              </div>

            </div>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="columnsToDisplay"></tr>
        <tr
          mat-row
          *matRowDef="let element; columns: columnsToDisplay"
          class="example-element-row"
          [class.example-expanded-row]="expandedElement === element"
          (click)="expandedElement = expandedElement === element ? null : element"
          (mouseenter)="onEnterRow(element)"
          (mouseleave)="onLeaveRow()"
          (dblclick)="openEditor()"
          (click)="onClickRow(element)"
          [ngClass]="{
                  'highlight-selected-dark' : element.id === clickedRow?.id && isDarkMode,
                  'highlight-selected' : element.id === clickedRow?.id && !isDarkMode,
                  'highlight-mouse-on-dark' : element.id === selectedRow?.id && isDarkMode,
                  'highlight-mouse-on' : element.id === selectedRow?.id && !isDarkMode
                  }"

        ></tr>
        <tr
          mat-row
          *matRowDef="let row; columns: ['expandedDetail']"
          class="example-detail-row"
        ></tr>
      </table>
      <mat-paginator *ngIf="!isWidget" [pageSizeOptions]="[10, 20, 30]" showFirstLastButtons></mat-paginator>
      <mat-paginator *ngIf="isWidget" [pageSizeOptions]="[10, 20, 30]" showFirstLastButtons></mat-paginator>
    </div>
  </mat-card-content>
</mat-card>







